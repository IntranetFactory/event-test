<link rel="import" href="components/tangere/tangere.html">

<dom-module id="event-source">
  <template>
    <style>
      :host {
        display: flex;
        box-sizing: border-box;

        flex-direction: row;
      }

      .label {
        display: block;
      }

      .input {
        flex: 1;
      }
    </style>

    <label id="label" for="input" class="label">{{label}}</label>
    <input id="input" type="text" placeholder$="[[placeholder]]" value$="[[value]]" class="input" />
  </template>
</dom-module>

<script>

  function shadowType(shadowRoot) {
    if (!shadowRoot) {
        // closed shadow dom does not appear to have a shadowRoot...
        // It could be assumed that it is v1, but for now return undefined
        return;
    }

    const content = document.createElement('content');
    // In browsers that support v1, but not v0 (ex: Safari)
    if (!content.getDistributedNodes) {
        return 'v1';
    }

    content.setAttribute('select', 'test-shadow-dom-version');
    shadowRoot.appendChild(content);

    const testElement = document.createElement('test-shadow-dom-version');
    shadowRoot.host.appendChild(testElement);
    const type = (content.getDistributedNodes().length) ? 'v0' : 'v1';
    shadowRoot.removeChild(content);
    shadowRoot.host.removeChild(testElement);

    return type;
  }

  window.shadowType = shadowType;

  Polymer({
    is: 'event-source',
    properties: {

      label: {
        type: String,
        value: '',
        title: 'Label'
      },

      placeholder: {
        type: String,
        value: '',
        title: 'Placeholder text'
      },

      value: {
        type: String,
        value: '',
        title: 'Value'
      },

      dispatchMethod: {
        type: String,
        value: 'event'
      }
    },

    ready: function() {

      var self = this;
      var valueProvider = this.$.input;

      valueProvider.addEventListener('change', function(e) {
        if (!this.dispatchMethod || this.dispatchMethod === "event") return;

        e.stopPropagation();
        var dm = this.dispatchMethod;
        var shadowType = window.shadowType(this.shadowRoot);

        if (dm === "fire") {
          this.fire('change', { value: e.target.value }, { bubbles: false });

        } else if (dm === "fire_bubbling") {
          this.fire('change', { value: e.target.value }, { bubbles: true });

        } else if (dm === "dispatch") {
          if (!this.shadowRoot || shadowType === "v0") {
            // custom event doesn't work in shadywDOM
            var event = new Event('change', { bubbles: false });
            event.detail = { value: e.target.value };
            this.dispatchEvent(event);
          
          } else {
            this.dispatchEvent(new CustomEvent('change', { bubbles: false, detail: { value: e.target.value } }));
          }
          
        } else if (dm === "dispatch_bubbling") {
          if (!this.shadowRoot || shadowType === "v0") {
            // custom event doesn't work in shadywDOM
            var event = new Event('change', { bubbles: true });
            event.detail = { value: e.target.value };
            this.dispatchEvent(event);
          
          } else {
            this.dispatchEvent(new CustomEvent('change', { bubbles: true, detail: { value: e.target.value } }));
          }

        } else if (dm === "dispatch_composed") {
          if (!this.shadowRoot || shadowType === "v0") {
            // custom event doesn't work in shadywDOM
            var event = new Event('change', { bubbles: true, composed: true });
            event.detail = { value: e.target.value };
            this.dispatchEvent(event);
          
          } else {
            this.dispatchEvent(new CustomEvent('change', { bubbles: true, composed: true, detail: { value: e.target.value } }));
          }
        }

      }.bind(this));
    }
  });
</script>
